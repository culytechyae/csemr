// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  CLINIC_MANAGER
  NURSE
  DOCTOR
  STAFF
}

enum Gender {
  MALE
  FEMALE
}

enum BloodType {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
  UNKNOWN
}

enum VisitType {
  ROUTINE_CHECKUP
  ILLNESS
  INJURY
  VACCINATION
  EMERGENCY
  FOLLOW_UP
}

enum HL7MessageStatus {
  PENDING
  SENT
  FAILED
  ACKNOWLEDGED
}

model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  passwordHash        String
  firstName           String
  lastName            String
  role                UserRole
  schoolId            String?
  isActive            Boolean   @default(true)
  // Security fields
  passwordChangedAt   DateTime?
  passwordExpiresAt   DateTime?
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  lastLoginAt         DateTime?
  lastLoginIp         String?
  mfaEnabled          Boolean   @default(false)
  mfaSecret           String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  school            School?              @relation(fields: [schoolId], references: [id])
  sessions          Session[]
  clinicalVisits    ClinicalVisit[]
  assessments       ClinicalAssessment[]
  healthRecords     HealthRecord[]
  passwordHistory   PasswordHistory[]
  loginAttempts     LoginAttempt[]
  emailLogs         EmailLog[]
  reportedIncidents SecurityIncident[]   @relation("ReportedIncidents")
  assignedIncidents SecurityIncident[]   @relation("AssignedIncidents")
  vendors           Vendor[]
  securityTrainings SecurityTraining[]

  @@index([email])
  @@index([schoolId])
  @@index([isActive])
}

model Session {
  id             String   @id @default(cuid())
  userId         String
  token          String   @unique
  expiresAt      DateTime
  ipAddress      String?
  userAgent      String?
  isActive       Boolean  @default(true)
  lastActivityAt DateTime @default(now())
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([isActive])
  @@index([expiresAt])
}

model School {
  id                  String   @id @default(cuid())
  name                String
  code                String   @unique
  address             String
  phone               String
  email               String?
  principalName       String
  currentAcademicYear String? // e.g., "2024-2025"
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  users         User[]
  students      Student[]
  visits        ClinicalVisit[]
  healthRecords HealthRecord[]
  hl7Messages   HL7Message[]
  hl7Config     SchoolHL7Config?

  @@index([code])
}

model Student {
  id                String    @id @default(cuid())
  schoolId          String
  studentId         String // School-specific student ID
  academicYear      String // e.g., "2024-2025"
  firstName         String
  lastName          String
  dateOfBirth       DateTime
  gender            Gender
  nationality       String?
  bloodType         BloodType @default(UNKNOWN)
  grade             String? // Student grade level
  homeroom          String? // Homeroom class/teacher
  studentEmiratesId String? // UAE Emirates ID
  parentName        String
  parentPhone       String
  parentEmail       String?
  emergencyContact  String
  emergencyPhone    String
  address           String?
  allergies         String?
  chronicConditions String?
  medications       String?
  isActive          Boolean   @default(true)
  enrolledAt        DateTime  @default(now())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  school        School               @relation(fields: [schoolId], references: [id])
  visits        ClinicalVisit[]
  assessments   ClinicalAssessment[]
  healthRecords HealthRecord[]
  hl7Messages   HL7Message[]

  @@unique([schoolId, studentId, academicYear])
  @@index([schoolId])
  @@index([studentId])
  @@index([academicYear])
}

model ClinicalVisit {
  id               String    @id @default(cuid())
  studentId        String
  schoolId         String
  visitDate        DateTime  @default(now())
  visitType        VisitType
  chiefComplaint   String?
  notes            String?
  diagnosis        String?
  treatment        String?
  followUpRequired Boolean   @default(false)
  followUpDate     DateTime?
  createdBy        String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  student     Student             @relation(fields: [studentId], references: [id])
  school      School              @relation(fields: [schoolId], references: [id])
  creator     User                @relation(fields: [createdBy], references: [id])
  assessment  ClinicalAssessment?
  hl7Messages HL7Message[]

  @@index([studentId])
  @@index([schoolId])
  @@index([visitDate])
}

model HealthRecord {
  id                              String   @id @default(cuid())
  studentId                       String
  schoolId                        String
  height                          Float? // in cm
  weight                          Float? // in kg
  bmi                             Float?
  colorBlindness                  String? // Normal/Abnormal
  visionTestingPerformed          Boolean? // Yes/No
  visionTestingNotPerformedReason String?
  correctiveLenses                String? // None, Glasses, Contact lenses, Surgical correction, Other
  correctiveLensesOtherReason     String?
  rightEye                        String? // Vision acuity (6/3, 6/6, etc.)
  leftEye                         String? // Vision acuity
  rightEyeWithCorrection          String? // Vision acuity with correction
  leftEyeWithCorrection           String? // Vision acuity with correction
  visionScreeningResult           String? // Normal/Abnormal
  recordedBy                      String
  recordedAt                      DateTime @default(now())
  createdAt                       DateTime @default(now())
  updatedAt                       DateTime @updatedAt

  student  Student @relation(fields: [studentId], references: [id])
  school   School  @relation(fields: [schoolId], references: [id])
  recorder User    @relation(fields: [recordedBy], references: [id])

  @@index([studentId])
  @@index([schoolId])
  @@index([recordedAt])
}

model ClinicalAssessment {
  id                              String   @id @default(cuid())
  visitId                         String   @unique
  studentId                       String
  temperature                     Float?
  bloodPressureSystolic           Int?
  bloodPressureDiastolic          Int?
  heartRate                       Int?
  respiratoryRate                 Int?
  oxygenSaturation                Float?
  height                          Float? // in cm
  weight                          Float? // in kg
  bmi                             Float?
  painScale                       Int? // 0-10
  generalAppearance               String?
  skinCondition                   String?
  eyes                            String?
  ears                            String?
  throat                          String?
  cardiovascular                  String?
  respiratory                     String?
  abdomen                         String?
  neurological                    String?
  otherFindings                   String?
  // Health Record fields
  colorBlindness                  String?
  visionTestingPerformed          Boolean?
  visionTestingNotPerformedReason String?
  correctiveLenses                String?
  correctiveLensesOtherReason     String?
  rightEye                        String?
  leftEye                         String?
  rightEyeWithCorrection          String?
  leftEyeWithCorrection           String?
  visionScreeningResult           String?
  createdBy                       String
  createdAt                       DateTime @default(now())
  updatedAt                       DateTime @updatedAt

  visit   ClinicalVisit @relation(fields: [visitId], references: [id], onDelete: Cascade)
  student Student       @relation(fields: [studentId], references: [id])
  creator User          @relation(fields: [createdBy], references: [id])

  @@index([studentId])
  @@index([visitId])
}

model HL7Message {
  id               String           @id @default(cuid())
  messageType      String // ADT, ORU, etc.
  messageControlId String           @unique
  studentId        String?
  visitId          String?
  schoolId         String
  messageContent   String           @db.Text
  status           HL7MessageStatus @default(PENDING)
  sentAt           DateTime?
  acknowledgedAt   DateTime?
  errorMessage     String?          @db.Text
  retryCount       Int              @default(0)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  student Student?       @relation(fields: [studentId], references: [id])
  visit   ClinicalVisit? @relation(fields: [visitId], references: [id])
  school  School         @relation(fields: [schoolId], references: [id])

  @@index([status])
  @@index([schoolId])
  @@index([messageControlId])
  @@index([createdAt])
}

model SchoolHL7Config {
  id                   String   @id @default(cuid())
  schoolId             String   @unique
  // MSH Segment Configuration
  facilityCode         String // DOH-assigned facility code (e.g., MF7163)
  sendingApplication   String   @default("SchoolClinicEMR")
  sendingFacility      String // Usually facility code or school code
  receivingApplication String   @default("Rhapsody")
  receivingFacility    String   @default("MALAFFI")
  processingId         String   @default("ADHIE") // Processing ID for MSH segment
  hl7Version           String   @default("2.5.1") // HL7 version
  // Transmission Settings
  autoSend             Boolean  @default(true)
  retryAttempts        Int      @default(3)
  // Doctor ID Configuration
  validDoctorIds       String?  @db.Text // Comma-separated list of valid doctor IDs
  defaultDoctorId      String? // Default doctor ID to use if provided ID is invalid
  // Message Type Settings (JSON string for which types to auto-send)
  autoSendMessageTypes String?  @db.Text // JSON array: ["ADT_A01", "ADT_A04", "ORU_R01"]
  // Environment Settings
  environment          String   @default("test") // "test" or "production"
  enabled              Boolean  @default(true) // Enable/disable HL7 for this school
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([enabled])
}

model PasswordHistory {
  id           String   @id @default(cuid())
  userId       String
  passwordHash String
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model LoginAttempt {
  id            String   @id @default(cuid())
  userId        String?
  email         String
  success       Boolean
  ipAddress     String?
  userAgent     String?
  failureReason String?
  createdAt     DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([userId])
  @@index([success])
  @@index([createdAt])
  @@index([ipAddress])
}

model SecurityEvent {
  id          String    @id @default(cuid())
  eventType   String // LOGIN_SUCCESS, LOGIN_FAILURE, PASSWORD_CHANGE, ACCOUNT_LOCKED, etc.
  userId      String?
  severity    String // LOW, MEDIUM, HIGH, CRITICAL
  description String    @db.Text
  ipAddress   String?
  userAgent   String?
  metadata    String?   @db.Text // JSON string for additional data
  resolved    Boolean   @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?
  createdAt   DateTime  @default(now())

  @@index([eventType])
  @@index([userId])
  @@index([severity])
  @@index([resolved])
  @@index([createdAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String
  changes    String?  @db.Text
  ipAddress  String?
  userAgent  String?
  severity   String   @default("INFO") // INFO, WARNING, ERROR, CRITICAL
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([severity])
  @@index([action])
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
  DELIVERED
}

model EmailLog {
  id           String      @id @default(cuid())
  to           String
  subject      String
  body         String      @db.Text
  html         String?     @db.Text
  status       EmailStatus @default(PENDING)
  templateType String? // WELCOME, PASSWORD_RESET, PARENT_VISIT_NOTIFICATION, etc.
  sentBy       String? // userId who triggered the email
  sentAt       DateTime?
  deliveredAt  DateTime?
  errorMessage String?     @db.Text
  retryCount   Int         @default(0)
  metadata     String?     @db.Text // JSON string for additional data
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  sentByUser User? @relation(fields: [sentBy], references: [id], onDelete: SetNull)

  @@index([to])
  @@index([status])
  @@index([templateType])
  @@index([sentBy])
  @@index([createdAt])
  @@index([sentAt])
}

enum IncidentSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum IncidentStatus {
  OPEN
  INVESTIGATING
  CONTAINED
  RESOLVED
  CLOSED
}

model SecurityIncident {
  id              String           @id @default(cuid())
  title           String
  description     String           @db.Text
  severity        IncidentSeverity
  status          IncidentStatus   @default(OPEN)
  category        String // UNAUTHORIZED_ACCESS, MALWARE, DATA_BREACH, POLICY_VIOLATION, etc.
  reportedBy      String? // userId who reported
  assignedTo      String? // userId assigned to investigate
  detectedAt      DateTime         @default(now())
  containedAt     DateTime?
  resolvedAt      DateTime?
  closedAt        DateTime?
  impact          String?          @db.Text
  rootCause       String?          @db.Text
  remediation     String?          @db.Text
  affectedSystems String?          @db.Text
  affectedData    String?          @db.Text
  breachConfirmed Boolean          @default(false)
  notified        Boolean          @default(false)
  notifiedAt      DateTime?
  metadata        String?          @db.Text // JSON string for additional data
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  reportedByUser User? @relation("ReportedIncidents", fields: [reportedBy], references: [id], onDelete: SetNull)
  assignedToUser User? @relation("AssignedIncidents", fields: [assignedTo], references: [id], onDelete: SetNull)

  @@index([severity])
  @@index([status])
  @@index([category])
  @@index([reportedBy])
  @@index([assignedTo])
  @@index([breachConfirmed])
  @@index([createdAt])
}

enum VendorStatus {
  PENDING
  APPROVED
  ACTIVE
  SUSPENDED
  TERMINATED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

model Vendor {
  id                     String       @id @default(cuid())
  name                   String
  contactName            String
  contactEmail           String
  contactPhone           String
  companyName            String
  address                String?
  status                 VendorStatus @default(PENDING)
  riskLevel              RiskLevel    @default(MEDIUM)
  hasSystemAccess        Boolean      @default(false)
  hasDataAccess          Boolean      @default(false)
  hasNetworkAccess       Boolean      @default(false)
  accessLevel            String? // NETWORK, SYSTEM, DATA, ALL
  services               String?      @db.Text
  contractStart          DateTime?
  contractEnd            DateTime?
  lastAssessment         DateTime?
  nextAssessment         DateTime?
  complianceStatus       String? // MALAFFI_COMPLIANT, ADHICS_COMPLIANT, HIPAA_COMPLIANT
  securityCertifications String?      @db.Text // ISO 27001, SOC 2, etc.
  slaDocument            String? // URL or file path
  ndaSigned              Boolean      @default(false)
  ndaSignedAt            DateTime?
  agreementSigned        Boolean      @default(false)
  agreementSignedAt      DateTime?
  notes                  String?      @db.Text
  createdBy              String? // userId who created
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt

  createdByUser User? @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([riskLevel])
  @@index([hasSystemAccess])
  @@index([hasDataAccess])
  @@index([lastAssessment])
  @@index([createdAt])
}

enum TrainingStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  EXPIRED
}

enum TrainingType {
  SECURITY_AWARENESS
  ANNUAL_REFRESHER
  ROLE_SPECIFIC
  INCIDENT_RESPONSE
  VENDOR_SECURITY
  COMPLIANCE
}

model SecurityTraining {
  id             String         @id @default(cuid())
  userId         String
  trainingType   TrainingType
  title          String
  description    String?        @db.Text
  status         TrainingStatus @default(PENDING)
  completedAt    DateTime?
  expiresAt      DateTime?
  certificateUrl String?
  score          Int?
  maxScore       Int?
  duration       Int? // in minutes
  trainingDate   DateTime?
  dueDate        DateTime?
  reminderSent   Boolean        @default(false)
  reminderSentAt DateTime?
  metadata       String?        @db.Text // JSON string for additional data
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([trainingType])
  @@index([status])
  @@index([dueDate])
  @@index([completedAt])
  @@index([createdAt])
}
